server {
    listen 80;
    server_name localhost;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name localhost;
    
    # HTTP/2 配置
    http2 on;
    
    ssl_certificate /etc/ssl/localhost+2.pem;
    ssl_certificate_key /etc/ssl/localhost+2-key.pem;
    
    root /usr/share/nginx/html;
    index index.html index.htm;

    # Brotli 动态压缩
    brotli on;
    brotli_comp_level 6;
    brotli_types text/plain text/css application/javascript application/json application/xml+rss application/xml image/svg+xml;
    brotli_static on;

    # Gzip 配置 - Unity WebGL 需要
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/wasm application/octet-stream;
    gzip_static on;

    # SPA fallback
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Unity WebGL .wasm 文件 (未压缩)
    location ~ \.wasm$ {
        default_type application/wasm;
        add_header Access-Control-Allow-Origin *;
    }

    # Unity WebGL Gzip 压缩文件
    location ~ \.wasm\.gz$ {
        add_header Content-Encoding gzip;
        default_type application/wasm;
        add_header Access-Control-Allow-Origin *;
    }

    location ~ \.data\.gz$ {
        add_header Content-Encoding gzip;
        default_type application/octet-stream;
        add_header Access-Control-Allow-Origin *;
    }

    location ~ \.framework\.js\.gz$ {
        add_header Content-Encoding gzip;
        default_type application/javascript;
        add_header Access-Control-Allow-Origin *;
    }

    location ~ \.js\.gz$ {
        add_header Content-Encoding gzip;
        default_type application/javascript;
        add_header Access-Control-Allow-Origin *;
    }

    location ~ \.symbols\.json\.gz$ {
        add_header Content-Encoding gzip;
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
    }

    # Unity WebGL Brotli 压缩文件
    location ~ \.wasm\.br$ {
        add_header Content-Encoding br;
        default_type application/wasm;
        add_header Access-Control-Allow-Origin *;
    }

    location ~ \.data\.br$ {
        add_header Content-Encoding br;
        default_type application/octet-stream;
        add_header Access-Control-Allow-Origin *;
    }

    location ~ \.framework\.js\.br$ {
        add_header Content-Encoding br;
        default_type application/javascript;
        add_header Access-Control-Allow-Origin *;
    }

    location ~ \.js\.br$ {
        add_header Content-Encoding br;
        default_type application/javascript;
        add_header Access-Control-Allow-Origin *;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}